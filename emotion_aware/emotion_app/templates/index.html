{% extends 'base.html' %}
{% block content %}

<div class="container mt-5 text-center">

    <h2 class="mb-4">Emotion Detection</h2>

    <!-- ================= IMAGE UPLOAD ================= -->
    <div class="card p-4 shadow mb-5">
        <h4>Upload Image</h4>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="image" required class="form-control mb-3">
            <button type="submit" class="btn btn-success">Predict</button>
        </form>

        {% if prediction %}
            <h4 class="mt-3 text-primary">Prediction: {{ prediction }}</h4>
        {% endif %}
    </div>


    <!-- ================= WEBCAM SECTION ================= -->

    <div class="card p-4 shadow">
        <h4>Webcam Emotion Detection</h4>

        <video id="video" width="500" height="375"
               autoplay playsinline
               style="border-radius:10px; border:2px solid #ccc;"></video>

        <canvas id="canvas" style="display:none;"></canvas>

        <br><br>

        <img id="preview" width="500"
             style="border-radius:10px; border:2px solid #ddd;">

        <br><br>

        <button class="btn btn-primary" onclick="capture()">
            Capture & Predict
        </button>

        <h4 id="result" class="mt-3 text-success"></h4>

    </div>

</div>


<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const preview = document.getElementById("preview");
const resultText = document.getElementById("result");

// START CAMERA
navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        video.srcObject = stream;
        video.play();
    })
    .catch(err => {
        alert("Camera access denied or not available.");
        console.error(err);
    });

function capture() {

    if (video.videoWidth === 0) {
        alert("Camera not ready. Please wait.");
        return;
    }

    const context = canvas.getContext("2d");

    // IMPORTANT: match canvas size to video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = canvas.toDataURL("image/jpeg");

    // SHOW PREVIEW (Fixes black image issue)
    preview.src = imageData;

    fetch("/webcam_predict/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ image: imageData })
    })
    .then(response => response.json())
    .then(data => {
        resultText.innerText = "Detected Emotion: " + data.emotion;
    })
    .catch(error => {
        console.error("Prediction error:", error);
    });
}

// CSRF TOKEN FUNCTION
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}